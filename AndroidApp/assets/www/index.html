<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- JS/CSS required libs -->
<link rel="stylesheet" href="css/jquery.mobile-1.2.0.min.css" />
<script type="text/javascript" src="js/cordova-2.0.0.js"></script>
<script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="js/jquery.mobile-1.2.0.min.js"></script>

<style type="text/css">
.loader {
	display: none;
}
</style>

</head>
<body>
<!-- 	Página inicial -->
	<div id="index" data-role="page">
		<!-- header -->
		<div data-role="header" data-id="header1" data-position="fixed">
			<h1>ImóvelAqui</h1>
		</div>
		<!-- /header -->

		<!-- content -->
		<div id="content" data-role="content">

			<h3>Escolha uma opção:</h3>
			<a href="#posAtual" data-transition="flip" data-role="button"
				data-theme="b">Pesquisar por posição atual</a>
			
			<a href="#locEspecifica" data-transition="flip" data-role="button"
				data-theme="b">Pesquisar por uma localização específica</a>

		</div>
	</div>
<!-- 	Fim da página inicial -->

<!-- Posição atual -->
	<div id="posAtual" data-role="page">
		<!-- header -->
		<div data-role="header" data-id="header1" data-position="fixed">
			<h1>ImóvelAqui</h1>
		</div>
		<!-- /header -->

		<!-- content -->
		<div id="content_1" data-role="content">
			<img src="images/ajax-loader.gif" class="loader" alt="loader" />
			<div id="mainAccordion" data-role="collapsible-set">

				<div id="frmSearch" data-role="collapsible" data-collapsed="false">
					<h3>Pesquisar</h3>
						<label for="distancia">Distancia em km:</label> <input type="range" name="distancia" id="distancia" value="5" min="1" max="10" />
						<a href="#resultPage" data-transition="flip" data-role="button" id="pesquisar" data-theme="b"
							name="pesquisar" onclick="loadRequestPosAtual()">Pesquisar</a>
				</div>

			</div>
		</div>
		<!-- /content -->
	</div>
<!-- 	Fim da página de posição atual -->

<!-- Localização Específica -->
	<div id="locEspecifica" data-role="page">
		<!-- header -->
		<div data-role="header" data-id="header1" data-position="fixed">
			<h1>ImóvelAqui</h1>
		</div>
		<!-- /header -->

			<!-- content -->
		<div id="content_1" data-role="content">
			<img src="images/ajax-loader.gif" class="loader" alt="loader" />
			<div id="mainAccordion" data-role="collapsible-set">

				<div id="frmSearch" data-role="collapsible" data-collapsed="false">
					<h3>Pesquisar</h3>
					<!--<form action="#" method="post">-->

						<label for="cidade">Cidade:</label> <input type="text"
							name="cidade" id="cidade" value="" /> <label for="bairro">Bairro:</label>
						<input type="text" name="bairro" id="bairro" value="" /> <label
							for="rua">Rua:</label> <input type="text" name="rua" id="rua"
							value="" />

						<a href="#resultPage" data-transition="flip" data-role="button" id="pesquisar" data-theme="b"
							name="pesquisar" onclick="loadRequestPosEsp()">Pesquisar</a>
					<!--</form>-->
				</div>
			</div>
		</div>
		<!-- /content -->
	</div>
<!-- 	Fim da página de localização específica -->

<!-- Página de resultados -->
	<div id="resultPage" data-role="page">
		<!-- header -->
		<div data-role="header" data-id="header1" data-position="fixed">
			<h1>ImóvelAqui</h1>
		</div>
		<!-- /header -->

		<!-- content -->
		<div id="content_2" data-role="content">
			
				<h3>Resultado</h3>
				<ul id="listView" data-role="listview" data-inset="true" data-filter="true">
				</ul>

		</div>
	</div>
<!-- 	Fim da página de resultados -->

<script type="text/javascript">
		var actualPosition;
		
		$(document).ready(function() {
			
			navigator.geolocation.getCurrentPosition(onSuccess, onError);
			
		});
		
		// onSuccess Geolocation
		function onSuccess(position) {
			actualPosition = position.coords;
		}
		
		function getPosition(){
			return actualPosition;			
		}

		// onError Callback receives a PositionError object
		function onError(error) {
			alert('code: ' + error.code + '\n' + 'message: ' + error.message
					+ '\n');
		}

		function loadRequestPosAtual() {
			var pos = getPosition();
			alert(pos.latitude);
			$.ajax({
						url : 'http://imovelaqui.co.cc/ModuloWeb/boundary/ModuloWebBoundary.action.php',
						type : 'post',
						data : {
							pesquisa : 'posicaoAtual',
							latitude : pos.latitude,
							longitude : pos.longitude,
//         			latitude: "-22.237233",
//         			longitude: "-45.9544205",
							distancia : $('#distancia').val()
						},
						dataType : 'json',
						//This method called when ajax request is succeful.
						success : function(jsonResponse) {
							var listContainer = $('#listView');
 							listContainer.empty();
							
							var list = new Array();
							var html = "";
							
							$.each(jsonResponse, function(i, objJsonResponse) {
								list[i] = $('<li class="ui-li ui-li-static ui-btn-up-c"></li>');

								html += "<a href='#'>";
								html += objJsonResponse.imovel_tipo;
								html += ": " + objJsonResponse.contrato_tipo;
								html += " - " + objJsonResponse.endereco;
								html += ", " + objJsonResponse.numero;
								html += "</a>";
								
								$(listContainer).append($(list[i]).html($(html)));
								html = "";
							});

						},
						//This method is called case request fail.
						error:function(xhr,err){
						    alert("readyState: "+xhr.readyState+"\nstatus: "+xhr.status);
						    alert("responseText: "+xhr.responseText);
						},
						//This method run before send ajax request.
						beforeSend : function() {
							$('.loader').css({
								display : "block"
							});
						},
						//This method run when complete ajax request.
						complete : function() {
							$.mobile.changePage("#resultPage",{transition:"slide"});

							$('.loader').css({
								display : "none"
							});
						}
					});
		}
		
		function loadRequestPosEsp() {
			$.ajax({
						url : 'http://imovelaqui.co.cc/ModuloWeb/boundary/ModuloWebBoundary.action.php',
						type : 'post',
						data : {
							pesquisa : 'locEspecifica',
							cidade : $("#cidade").val(),
							bairro : $("#bairro").val(),
							rua : $("#rua").val()
						},
						dataType : 'json',
						//This method called when ajax request is succeful.
						success : function(jsonResponse) {
							var listContainer = $('#listView');
							listContainer.empty();

							var list = new Array();
							var html = "";

							$.each(jsonResponse, function(i, objJsonResponse) {
								list[i] = $('<li class="ui-li ui-li-static ui-btn-up-c"></li>');

								html += "<a href='#'>";
								html += objJsonResponse.imovel_tipo;
								html += ": " + objJsonResponse.contrato_tipo;
								html += " - " + objJsonResponse.endereco;
								html += ", " + objJsonResponse.numero;
								html += "</a>";

								$(listContainer).append($(list[i]).html($(html)));
								html = "";
							});

						},
						//This method is called case request fail.
						error : function(xhr, err) {
							alert("readyState: " + xhr.readyState
									+ "\nstatus: " + xhr.status);
							alert("responseText: " + xhr.responseText);
						},
						//This method run before send ajax request.
						beforeSend : function() {
 							$('.loader').css({
 								display : "block"
 							});
						},
						//This method run when complete ajax request.
						complete : function() {
							$.mobile.changePage("#resultPage",{transition:"slide"});
							$('.loader').css({
								display : "none"
 							});
						}

					});

		}
	</script>
</body>
</html>